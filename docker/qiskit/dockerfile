# ========================
# Stage 1: Build Stage
# ========================
FROM python:3.10-slim as builder

ARG UID=1000
ARG GID=1000

# Install essential build tools and libraries
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    build-essential \
    curl \
    lcov \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Python packages needed for building and testing
RUN pip install --no-cache-dir \
    coverage==7.6.2 \
    cython \
    unidiff \
    click \
    rich \
    pytest \
    pytest-cov

# Create a non-root user and prepare the /opt directory
RUN groupadd -g $GID regularuser && \
    useradd -m -u $UID -g $GID -s /bin/bash regularuser && \
    mkdir -p /opt && chown -R regularuser /opt

# Switch to non-root user for subsequent steps
USER regularuser

# Install Rust (required for parts of Qiskit)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \
      | sh -s -- --default-toolchain none -y && \
    echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc && \
    echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.profile && \
    /bin/bash -c "source ~/.cargo/env && rustup update stable" && \
    /bin/bash -c "source ~/.cargo/env && rustup component add llvm-tools-preview"

# Ensure Cargoâ€™s bin directory is in PATH
ENV PATH="/home/regularuser/.cargo/bin:${PATH}"

# Clone the Qiskit repository
WORKDIR /opt
RUN git clone https://github.com/Qiskit/qiskit.git

# Checkout the desired pull request
WORKDIR /opt/qiskit
ARG PR_NUMBER
RUN git config --global alias.pr '!f() { git fetch -fu ${2:-origin} refs/pull/$1/head:pr/$1 && git checkout pr/$1; }; f' \
    && git pr $PR_NUMBER

# Install Qiskit in editable mode. If constraints.txt exists, use it.
RUN if [ -f constraints.txt ]; then \
        pip install -c constraints.txt --upgrade pip setuptools wheel && \
        pip install -c constraints.txt -e . ; \
    else \
        pip install --upgrade pip setuptools wheel && \
        pip install -e . ; \
    fi

RUN pip install --no-cache-dir -r requirements-dev.txt

# Set the working directory as desired (here /workspace)
WORKDIR /workspace

# Verify installation by printing the Qiskit version
# CMD ["python", "-c", "import qiskit; print(qiskit.__version__)"]

CMD ["tail", "-f", "/dev/null"]
